# 事务\(transaction\)ACID



* **Atomic** – Transaction acting on several pieces of information complete only if all pieces successfully save.   Here, “all or nothing” applies to the transaction.
* **Consistent** – The saved data cannot violate the integrity of the database. Interrupted modifications are rolled back to ensure the database is in a state before the change takes place.
* **Isolation** – No other transactions take place and affect the transaction in question.   This prevents “mid-air collisions.”
* **Durable** – System failures or restarts do not affect committed transactions. 



1. 原子性（Atomic）     一个事务包含多个操作，这些操作要么全部执行，要么全都不执行。实现事务的原子性，要支持回滚操作，在某个操作失败后，回滚到事务执行之前的状态。     回滚实际上是一个比较高层抽象的概念，大多数DB在实现事务时，是在事务操作的数据快照上进行的（比如，MVCC），并不修改实际的数据，如果有错并不会提交，所以很自然的支持回滚。     而在其他支持简单事务的系统中，不会在快照上更新，而直接操作实际数据。可以先预演一边所有要执行的操作，如果失败则这些操作不会被执行，通过这种方式很简单的实现了原子性。
2. 一致性（Consistency）

   一致性是指事务使得系统从一个一致的状态转换到另一个一致状态。事务的一致性决定了一个系统设计和实现的复杂度，也导致了事务的不同隔离级别。

事务可以不同程度的一致性：  
**强一致性**：读操作可以立即读到提交的更新操作。  
**弱一致性**：提交的更新操作，不一定立即会被读操作读到，此种情况会存在一个不一致窗口，指的是读操作可以读到最新值的一段时间。  
**最终一致性**：是弱一致性的特例。事务更新一份数据，最终一致性保证在没有其他事务更新同样的值的话，最终所有的事务都会读到之前事务更新的最新值。如果没有错误发生，不一致窗口的大小依赖于：通信延迟，系统负载等。  
 其他一致性变体还有：  
**单调一致性**：如果一个进程已经读到一个值，那么后续不会读到更早的值。  
**会话一致性**：保证客户端和服务器交互的会话过程中，读操作可以读到更新操作后的最新值。

3. 隔离性（Isolation）

  
 并发事务之间互相影响的程度，比如一个事务会不会读取到另一个未提交的事务修改的数据。在事务并发操作时，可能出现的问题有：  
**脏读\(dirty reads\)**：事务A修改了一个数据，但未提交，事务B读到了事务A未提交的更新结果，如果事务A提交失败，事务B读到的就是脏数据。  
**不可重复读\(unrepeatable reads\)**：在同一个事务中，对于同一份数据读取到的结果不一致。比如，事务B在事务A提交前读到的结果，和提交后读到的结果可能不同。不可重复读出现的原因就是事务并发修改记录，要避免这种情况，最简单的方法就是对要修改的记录加锁，这回导致锁竞争加剧，影响性能。另一种方法是通过MVCC可以在无锁的情况下，避免不可重复读。  
**幻读\(phantom problem\)**：在同一个事务中，同一个查询多次返回的结果不一致。事务A新增了一条记录，事务B在事务A提交前后各执行了一次查询操作，发现后一次比前一次多了一条记录。幻读是由于并发事务增加记录导致的，这个不能像不可重复读通过记录加锁解决，因为对于新增的记录根本无法加锁。需要将事务串行化，才能避免幻读。  
 事务的隔离级别从低到高有：  
**Read Uncommitted**：最低的隔离级别，什么都不需要做，一个事务可以读到另一个事务未提交的结果。所有的并发事务问题都会发生。  
**Read Committed**：只有在事务提交后，其更新结果才会被其他事务看见。可以解决脏读问题。  
**Repeated Read**：在一个事务中，对于同一份数据的读取结果总是相同的，无论是否有其他事务对这份数据进行操作，以及这个事务是否提交。可以解决脏读、不可重复读。  
 **Serialization**：事务串行化执行，隔离级别最高，牺牲了系统的并发性。可以解决并发事务的所有问题。  
 通常，在工程实践中，为了性能的考虑会对隔离性进行折中。

![](.gitbook/assets/image%20%2810%29.png)

4. 持久性（Durability）

 事务提交后，对系统的影响是永久的



常见的例子就是银行转账，A账户给B账户转账一个亿\(T1\)，买一块地盖房子。在这种交易的过程中，有几个问题值得思考：

* 如何**同时保证**上述交易中，A账户总金额减少一个亿，B账户总金额增加一个亿？ A
* A账户如果同时在和C账户交易\(T2\)，如何让这两笔交易互不影响？ I
* 如果交易完成时数据库突然崩溃，如何保证交易数据成功保存在数据库中？ D
* 如何在支持大量交易的同时，保证数据的合法性\(没有钱凭空产生或消失\) ？ C



作者：wuxinliulei 链接：[https://www.zhihu.com/question/31346392/answer/59815366](https://www.zhihu.com/question/31346392/answer/59815366) 来源：知乎 著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

